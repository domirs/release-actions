name: Create Final Release

on:
  workflow_dispatch: # Allows manual triggering

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Fetch full history including tags

      - name: Check branch is not main
        run: |
          CURRENT_BRANCH=${GITHUB_REF#refs/heads/}
          echo "Current branch: $CURRENT_BRANCH"

          if [ "$CURRENT_BRANCH" = "main" ]; then
            echo "❌ Error: Final release should not be created from the main branch."
            echo "Please run this workflow from a release branch."
            exit 1
          fi

          echo "✅ Branch check passed. Creating final release from branch: $CURRENT_BRANCH"

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "lts/*"

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate and prepare release version
        id: release-version
        run: |
          # Get the current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"

          # Check if current version is a release candidate
          if [[ ! "$CURRENT_VERSION" =~ -rc\.[0-9]+$ ]]; then
            echo "❌ Error: Current version '$CURRENT_VERSION' is not a release candidate."
            echo "Please run this workflow only from a branch with a -rc.X version."
            exit 1
          fi

          # Remove the -rc.X suffix to get final version
          FINAL_VERSION=$(echo $CURRENT_VERSION | sed 's/-rc\.[0-9]*$//')
          echo "Final release version: $FINAL_VERSION"

          # Check if this release tag already exists
          if git tag -l | grep -q "^v${FINAL_VERSION}$"; then
            echo "❌ Error: Release tag v$FINAL_VERSION already exists."
            echo "Please check existing releases or update the version number."
            exit 1
          fi

          # Export for next steps
          echo "final_version=$FINAL_VERSION" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Update package.json to final version
        run: |
          FINAL_VERSION="${{ steps.release-version.outputs.final_version }}"

          # Update package.json version
          npm version $FINAL_VERSION --no-git-tag-version

          echo "Updated package.json to final version: $FINAL_VERSION"

      - name: Commit final version
        run: |
          FINAL_VERSION="${{ steps.release-version.outputs.final_version }}"
          CURRENT_BRANCH=${GITHUB_REF#refs/heads/}

          # Commit the version change
          git add package.json package-lock.json
          git commit -m "chore: :bookmark: Release v$FINAL_VERSION"

          # Create and push final release tag
          git tag "v$FINAL_VERSION"
          git push origin "v$FINAL_VERSION"

          # Push the commit to current branch
          git push origin HEAD

          echo "Created final release tag: v$FINAL_VERSION"

      - name: Merge to main and cleanup
        run: |
          CURRENT_BRANCH=${GITHUB_REF#refs/heads/}
          FINAL_VERSION="${{ steps.release-version.outputs.final_version }}"

          echo "Merging $CURRENT_BRANCH into main..."

          # Switch to main branch
          git checkout main
          git pull origin main

          # Merge the release branch
          git merge --no-ff $CURRENT_BRANCH -m "Merge release branch for v$FINAL_VERSION"

          # Push the merge to main
          git push origin main

          # Delete the release branch on the server
          git push origin --delete $CURRENT_BRANCH

          echo "✅ Successfully:"
          echo "  - Merged $CURRENT_BRANCH into main"
          echo "  - Deleted $CURRENT_BRANCH branch on server"
          echo "  - Created final release v$FINAL_VERSION"
